use core::byte_array::ByteArrayTrait;
use aster::models::{
    seed::{SeederTrait},
    props::{
        props::{AsterProps, Distribution},
        palette::{Palette, PaletteTrait},
    },
};
use aster::utils::math::{SafeMathU32};

const RESOLUTION: usize = 1200;
const SIZE: usize = 70;
const HALF_SIZE: usize = 35;

#[generate_trait]
pub impl AsterRendererImpl of AsterRendererTrait {

    //------------------------
    // SVG builder
    //
    fn render_svg(ref props: AsterProps) -> ByteArray {
        //
        // gether data
        let palette_styles: ByteArray = props.palette.get_styles();
        let distribution: Distribution = props.distribution;
        let density: usize = props.density;
//-------
// DEBUG
let _pnum: u8 = ((props.token_id-1) / 6).try_into().unwrap() + 1;
let _palette: Palette = _pnum.into();
let palette_styles: ByteArray = _palette.get_styles();
let density: usize = (((props.token_id-1) % 6) + 1).try_into().unwrap();
let distribution: Distribution =
    if (props.token_id <= 6) {Distribution::Order}
    else if (props.token_id <= 12) {Distribution::Spread}
    else {Distribution::Chaos};
//-------
        let VIEWPORT_W: usize = (SIZE * density);
        let VIEWPORT_H: usize = (SIZE * density);

        //---------------------------
        // Build SVG
        //
        let mut result: ByteArray = "";
        result.append(@format!(
            "<svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" version=\"1.1\" width=\"{}\" height=\"{}\" viewBox=\"0 0 {} {}\">",
            RESOLUTION,
            RESOLUTION,
            VIEWPORT_W,
            VIEWPORT_H,
        ));
        //
        // styles
        // result.append(@format!(
        //     "<style>.bl{{mix-blend-mode:screen;}}.bg{{fill:{};}}.p0{{fill:{};}}.p1{{fill:{};}}.p2{{fill:{};}}.p3{{fill:{};}}.p4{{fill:{};}}.m0{{fill:{};}}.m1{{fill:{};}}.m2{{fill:{};}}.m3{{fill:{};}}</style>",
        //         color_bg,
        //         colors.at(0),
        //         colors.at(1),
        //         colors.at(2),
        //         colors.at(3),
        //         colors.at(4),
        //         colors.at(5),
        //         colors.at(6),
        //         colors.at(7),
        //         colors.at(8),
        // ));
        let r0: u16 = props.seeder.get_next_u16(360);
        let r1: u16 = props.seeder.get_next_u16(360);
        let r2: u16 = props.seeder.get_next_u16(360);
        let r3: u16 = props.seeder.get_next_u16(360);
        let r4: u16 = props.seeder.get_next_u16(360);
        result.append(@format!(
            "<style>.bl{{mix-blend-mode:screen;}}.r{{transform-origin:center;transform-box:fill-box;}}.r0{{transform:rotate({}deg);}}.r1{{transform:rotate({}deg);}}.r2{{transform:rotate({}deg);}}.r3{{transform:rotate({}deg);}}.r4{{transform:rotate({}deg);}}{}</style>",
            r0, r1, r2, r3, r4,
            palette_styles,
        ));
        //
        // layers defs
        // TODO: pre-encode this...
        result.append(@"<defs>");
        result.append(@"<path id=\"p0\" d=\"M62.8,37.5c-7.8-3.3,2.5-2.1,1.2-6.4c-1.2-9.2-5.9-5.8-13.7-5.2c4.4-1.5,15.6-12.4,5.6-8.6 c-3.5,1,2.5-9.9-8.1-1.7c1.1-4.7-3.6-4.5-5.7-1.2c0.1-8.9-6.1-10.6-6.8-0.7c-0.4-8.2-7.7-5-5.8,1c-3.5-9.8-10.6-9.2-6.1,1.8 c-6.8-6.5-10.2-0.4-4.4,5.1c-5.8-3.8-13.1,0.3-5.4,5.3c1.2,0.5,1.3,1,0,0.9c-6.4,1-6.7,4.7-0.9,6.7c-5.2,1.9-4.7,7.5,1.6,6 c-3.4,1.8-5.6,6.1,0.1,6.3c-3.8,8,3.8,6.7,7,3c-2.9,3.7-1.6,11.6,3.3,6c1-0.8,3.8-6.1,3.8-4.1c-0.2,2,1,11.1,4.5,8.3 c1.3-1,1.7,1.2,2.9,0.8c3.7,1.3,2.1-7.1,4.3-3.8c5.8,9.5,3.9-6.2,2.2-9.8c3,2.8,11.4,14.7,11.7,5c-0.2-1.3,0.7-1.1,1.5-1 c7,0.5-3.5-8.8-5.4-10.6C53.4,40.7,69.5,44.2,62.8,37.5z\"/>");
        result.append(@"<path id=\"p1\" d=\"M54.3,24.8c0.7-3.5,7.1-2.3,6-6.5c-0.4-1.6-2.5-2.1-3.6-1.2c0.3,0.4-0.4-0.2,0.1-0.2 c4.1-3.1-5.8-5.9-8.3-3.9c-0.9,0.4-1.7,1.3-2.8,0.4c-5.4-3.7-6.9,3.2-9.9,4.6c-0.6-14.9-6.7-6.2-6,3.5c-2.8-4.6-2.9-11.4-7.4-13.8 c-1.5,0,0,2.2-1.5,2.7c-1.8-2.2-5.7-2.8-3.8,1c5.5,15.9,2.2,5.6-6.7,7.3c2.5,1.8,4.9,3.2,7.1,5.5c-12.2-1.6,2,4.1,5,7.3 c-10.1-3.1-15.6,0.7-2.1,3.4c-6.3,0.9-9.2,9.2-1,5.5c-0.2,1.4-4.2,8.1,2.6,6.7c3.3-1.3-0.7,13.3,6.9,5.3c0.7-0.1,0.2-2.7,1.8-0.8 c0.2,2.5-3.9,5.3,0.8,5.7c2.4-0.1,2.6,4.5,5.4,1.9c3.3-3.1,0.9-5.3,0.9-9.2c2.8,8.6,12.4,23.2,6.2,3.3c2.1,2,3.6,3.4,5,4.8 c2.7-3,2-5.5,0.2-7.8c9.6,5.4,5.4-7.4-0.2-9.5c13.8,2.9,12.8-5.8,0.6-7.3c7.1-0.1,13.6-6.2,2.3-6.1C52.9,26.6,53.7,25.8,54.3,24.8z\"/>");
        result.append(@"<path id=\"p2\" d=\"M63.5,26.1c-1.3-2.3-3.2-2.6-5.4-1.6c0.9-1.2,3.9-1.9,2-4c-1.4-1.5-0.7-2,0-3.1c2.5-6-6.5-2.8-8.6-0.3 c8.8-13.3-5.4-5.5-8.3,1.5c-0.3-2.2-0.8-4.4-3.4-5c-0.2-0.8-1.4,1.5-1.1-0.4c-2-10.2-7.8-13-7.2,0.4C27,5,21.8,3.7,24.2,14.8 c-13.6-8.6-5.5,3.9-0.7,9.2C20,21.4-0.2,11.6,9.9,22.4c-2.3,2.5-4.9-0.6-2.3,4.5c1.8,4.3,5.6,4.9,9.1,6.7c-4.2,0.3-17.1,4-6.4,6.1 c0.5,0,1.1,0,1.6-0.1c2.9,1-1.1,1-0.2,1.7c-4.4,0.1-9.2,6.1-1.9,5.1c3.2,0.1-3.3,4.8,3.6,4.6C20,47.7,4.7,66.7,26,53.4 c0.5,3.1-0.4,4.8,1.1,8.5c0.9,0.5,4.4,5.3,4.6,3.4c0.4-3.4,1.8-5.6,3.3-7.4c1.5,8.5,8.5,16.7,6.9,2c4.3,5.4,6-0.5,3.5-4.5 c3.6,1.3,10.4,6.6,8.4-0.7c8.6,4.5,5.3-9.2-1-8.6c0.1-0.7-0.5-1.8-1.2-1.9c1.3-0.6,8.3,1.6,9.4-1.9c0.5-2.7-2.6-4.2-4.8-4.5 c4.3,0.2,2.4-5.1,5.7-6.3C64.3,30.1,64.7,28.3,63.5,26.1z M31.4,42c-2.1-0.1-3.3-2.6-5-3.7C35.9,8.4,56.8,45.8,31.4,42z\"/>");
        result.append(@"<g id=\"p3\"><path d=\"M26.8,28.5c0.3-2,1.1-1.5,2.6-1.2c3.6-0.6-2.3-5-1.3-7c1,4.1,6.8,4.4,7.5-0.1c-0.9,3.3,3.5,11.1,6.9,6.1 c1.2,9.7,15.3-0.3,18.9-4.1c3.8-4.3-3.3-4.6-2.3-8.5c-5.5-11.9-9.8-1.5-14.4,5.1c-1.6-4.7,1.7-8.8,0.8-13 c-3.3-2.3-4.7,0.9-6.9,3.1c0.7-9.8-6.8-6.8-4.8,1c-2.2-2.9-1.1-6.2-2.1-9.4c-6.1-0.1-6.3,0.2-5.6,5.4c-1.8,1.2-2.6-0.9-3.9-1.3 c-7.7-8.5-6,8.9-4.3,12.5c-6.7-5.6-10.7-3.1-9.5,5.2C6.3,23.8,8.3,25,9,25.9C11.6,29.1,24.4,32.7,26.8,28.5z M22.7,22.7 c-1.3-0.4-2-1.4-2.6-2.4c1.2,1.2,2.7,2.2,4.3,3.1C23.8,23.9,23.4,22.9,22.7,22.7z\"/><path d=\"M23.3,44.5c15.7-4-11.3-13.6-16-10.8c-7.7,4,3.6,7.9,7.8,6.7c-3.8,0.8-5.8,7.8-1.2,8.8 C17.5,48.3,19,44,23.3,44.5z\"/><path d=\"M28.7,60.3c1.5-1.9,5.2-0.3,5.7-3.7c-1.1-3.9,4.6-12-2.2-13c-2.3,4.1-7.7,5.3-8.4,10.7 C22.5,60.5,22.5,70.8,28.7,60.3z\"/><path d=\"M44.2,55.9c0.3-4.3-1.7-9.4-5.5-11.8C33.7,46.3,41.4,61.5,44.2,55.9z\"/><path d=\"M64.6,25.8C59.2,29.7,44.7,28,45,35.4C50.8,32.7,64,33.5,64.6,25.8z\"/><path d=\"M45.4,40.7c6.3,9,15.9-9.9,4.6-4.9C48.7,37.8,43.9,36.4,45.4,40.7z\"/><path d=\"M41.4,42.5c-2.9,2.5,10.4,13.3,7.8,6.2C47.5,46.4,44.7,40.4,41.4,42.5z\"/></g>");
        result.append(@"<g id=\"p4\"><path d=\"M32.9,43.2c-2.7-0.3-4.9-4.3-7.4-3.4c-0.3-3.7,3.3-6,1.7-10.3c2.9,2.9,3-3.2,5-4.3c2.5-2.2,5.1,0.4,7.6-0.7 c0.9-0.4,1.1,2,2.4,2c2.2-1.2,4.3-3.2,5.5-5.3c1.7-5.3,0.3-5.8-4.5-6.4c-0.6-1.5,0.3-2.7,0.7-4c0.8-2.7,0.9-6.2-0.8-6.2 c-0.3,0-2.1,1.2-2.4,0.7c-1.9-5.9-6.5,2.7-3.9,5.8c0.8,1.8,1.6,3.8-0.4,6.1c1.8-16.5-14-11-5.4,0.9c0.4,0.9,2.4,3.6,0.3,2.4 c-4.4-3.5-5-11.4-11.4-12.7c-3,1.3-3,1.5,0.1,6.4c-3.3-3.3-9.4-6.9-9.7,0.2c-0.6,4.9,5.4,7.9,8.3,11c-15.3-1.8-10.1,5.2,1.2,6.3 c-8.7,0.1-20.7,8.5-4.6,8.2c-18.3,10.3,1.6,6.5,8.5,1.1C20,45.3,8.1,60.4,22.5,54c-1.9,3.4-0.8,7.9,3,4.2 C26.6,69.2,36.7,46.3,32.9,43.2z\"/><path d=\"M44.3,51.4c-0.2-2.9-7.5-17.9-7.3-7.9c0,0.8,1.7,2.9-1.2,1.7c-4.7,4.1,4.2,29.7,3.2,8 c2.6,1.4,2.6,6.3,5.6,5.8C46.6,57.6,44.2,53.7,44.3,51.4z\"/><path d=\"M64.9,26c-1.8-2.6-6.1,0.2-8.8,0.1c0.9-2.8,5.8-3.7,4.7-6.6c-2.9-1.7-14,4.5-16.2,7.5 c-2.3,1.9-0.2,4.7,2.3,2.8c0.8-0.1,2.5-2.2,1.9,0.9C52.8,33.2,61.7,28.7,64.9,26z\"/><path d=\"M53.1,33.9c-3.4,2.2-10-2.8-8.9,3.9c0.9,2.6-1.7,4.7-1.2,7.3c0.9,2.1,8,8.7,8.3,4.2c-0.8-5,1.4-0.7,3-2.4 c0.7-1.1,0.1-2.2-0.7-3.1C49.1,40.6,57.8,37.2,53.1,33.9z\"/></g>");
        result.append(@"<g id=\"p5\"><path d=\"M35,24.6c1.7,0.1,1.6,1.4,2.8,1.9c2.5-0.7,5,3.6,6.6,4.9c-4.2,4.9,2.7,3.9,1.6,7.4c-0.7,1.1-5.4-2.2-3.2,1.7 c-3.7,0.6,5.8,14.6,8,13.8c1.7-2.4-1.7-6.6-3.1-9c3.1,4.2,12.4,6.2,6.4-0.9c6.4,4.3,2.8-6.5-1.9-5.9c4.5,1.5,12.5,1,2.9-3.8 c13.7-1.6-1.1-3.4,5.5-5.2c2.7-0.4,2.6-3-0.3-2.8c-0.5-0.1-1.3,0.5-1.4-0.7c-1.6-4.5-8.8,0.8-11.1-0.9c-1.6-2.6-2.5,0.5-3.9,0.5 c1.1-4,3.3-8,4.6-12.3c0.7-6.5-5.5,1.7-7.1,3.9c3-13.7-3.7-5.7-5.6,2.2c0.5-3-3.8-15.4-4.6-8.2\"/><path d=\"M37.7,43.2c-3.4-0.5-3.3,1.5-6.2,2.3c-1.5-1.2-2.8-8-4.6-5.6C19,43.2,9.9,63,24,49.3c-5.3,14.8,4.7,4.3,7-2.6 c-0.9,4.6-1.5,18.4,3.5,7.6c2.5,11.3,2.7,3.3,6.7-0.7C44.7,50.6,41.1,44.9,37.7,43.2z\"/><path d=\"M26.9,36.7c0-1-1.9-0.7-1.1-2.2c0.3-0.7-0.8-1.5-1.9-0.8c-6.9-0.5-25.1,6.5-8.1,7.1c-1.7,0.8-3.3,1.5-5,2.3 C13.1,45.9,28.8,40.1,26.9,36.7z\"/><path d=\"M11.6,29.5c4.6,2.3,9.8,3.7,14.9,3.2c1,0.5,1.8-1.1,1.5-2.1c-0.3-1.2,0.5-1.5,1.4-1.9c1.1-0.5,0.7-2,1.7-2.5 C38,24.4,18.5,1,20.7,13.7c-5.9-1.7-2,3.9-0.6,6.5C17.5,19,9.7,17.4,14,21.8c1.4,3.7,8.4,3.3,10.5,7C22.3,27.8,4.7,24.3,11.6,29.5 z\"/></g>");
        result.append(@"<g id=\"p6\"><path d=\"M60.4,37.9c-1.8-0.9-3.6-1.8-6.1-3.1c13.3-0.2,5.3-13.2-4.1-11.7c3-2.3,2.8-6.1,2.2-9.3 c-1.7-1.6-3,1.3-4.7,0.6c3-7.8-3.8-5.6-5.8-0.7C44,1.3,34.4,6,34.6,15.5c1-6.9-8.6-12.1-6.6-2.2c-0.7-1.3-1.6-2.5-3.3-2.6 c-4.4-2,0.1,5.4-2,6C18,18,23,22,23.5,24.6c-3.7-0.5-7.2-6.3-10.7-4.2c-1.8,3,3.2,6.3,5.1,7.9c-4.5-4.6-5.9,1.3-1.6,4.1 c-17.8,4.6,0.1,5.7,7.2,5.5c2.2-2.4,5.2-5,3.7-10c5.2-0.7,8.5-4.7,14-2.8c1.9-0.4-0.3,2.2,1.3,2.4c4.2,0.8,0.2,5.5,3.7,7.4 c-7.2,0.6,0.2,6.6-4.7,6.6c-10.2-1,12.3,27,5.5,7.8c6.6,6.1,9.7,1.9,4-4.1c2.5-0.4,4.8,2.4,6.7,0.3c1.5-1.6-1.8-2.4-1.5-4.1 C59.2,42.4,65.8,41,60.4,37.9z\"/><path d=\"M22.9,48.7L22.9,48.7L22.9,48.7z\"/><path d=\"M27.7,42.7c0.8-3.2-1.5-3.1-3.5-3.4C21.7,39,8,52.2,14.1,52.3C20.2,51.9,24.2,47.3,27.7,42.7z\"/><path d=\"M27,45.8c-0.8,4.2-5.2,9.3-3.7,13.3C28.3,60.8,37,40,27,45.8z\"/><path d=\"M35.9,44.2c-4.1,1.5-2.5,13.9,0.4,15.9C42.4,60.9,38.3,45.9,35.9,44.2z\"/></g>");
        result.append(@"<g id=\"p7\"><path d=\"M16.7,20.9c0.7,4.7,14.1,12.1,12.2,3.7C30.1,17.9,8.5,12,16.7,20.9z\"/><path d=\"M13.7,35.6c3.2,1,10.4,2.8,12.5,0C27.6,28.9,7.3,32,13.7,35.6z\"/><path d=\"M59.6,39.7C37.3,28,47.7,48,30.6,43.9c-2.1,0.1-1.1-1.6-1.3-2.5c-1-10.5-30,0.6-10.2,0.9 c-7.4,3.5-8.5,10.3,1.1,6.7c-2.8,5.8,1.3,6.5,5.5,4c-4.2,14.7,5.3,6,8.6-1.2c-2.7,11.9,3.5,15.5,4.6,1.6c0.4,0.3,0.9,0.5,1.4,0.3 c-0.6,8.9,7.3,15.1,6.1,2.2c0.8,4.3,8.3,9.5,7.6,1.9c-0.1-1.7-1.4-3.5,0.4-5c1.6-4.2-2.8-7.8-5.3-10.5 C52.7,45.4,67.6,47.3,59.6,39.7z M49.8,39C49.8,38.9,49.8,38.9,49.8,39c0-0.1,0.1-0.1,0.2-0.1C49.9,38.9,49.8,39,49.8,39z\"/><path d=\"M33.7,26.8c1.1-0.4,1.6-1.4,2.2-2.3c-1.7,4.6,4.6,2.4,5.5-0.2c-0.5,3.9-0.8,6.5,4.1,4.6 c4.1-1.6,9.6-1.6,11.4-6.3c2.2-1,3.1-3.7,2.8-6.1l0,0c0.9-7.6-12.5,2.8-15.1,4.7c0.3-3.3,3.4-4.9,4.8-7.5c0.5-1,2.5-1.5,1.3-3 c-4.9-2.5-10,5.1-12.1,9C35.3,18,42.7,9.6,40,7.2C32.7,2.6,28.7,25.8,33.7,26.8z\"/></g>");
        result.append(@"<g id=\"p8\"><path d=\"M46.4,25.8c2.2-3,6.3-17.7-1.2-11.9c-5.1-4.8-4.4,3.3-7.3,3.4c-0.7,0-0.1,2.3-2.2,2.5 c1.6-9.9-12.5-18.9-6.1-3.5c-1.3-4.1-6-5.7-9.6-7.1c-4.9,4.3,0.7,7.9,0.6,11.9c-9.6-10.3-14.3,1.8-4.8,6c-2.1-0.5-4.2-2-6.3-2.8 c-6.6-2.4-5.5,5.7,0.7,6c-9.7-0.2-6.7,11.2,2.2,8.2c-1.8,0.4-4.3,0.6-4.2,2.9c2,5.1,12,1.5,15.8-0.3c-2.7,2.7-6.5,4.4-8.6,8.6 c2.4-0.7,4-1.2,6-1.8c-1.7,12.7,18.8-9.7,5.1-8.7c4.1-3.3-2.5-7.3,1.8-9.2C34,26.8,43.3,31.2,46.4,25.8z\"/><path d=\"M37.3,43.3c-6.6-1.2-2.5,6.9-2.9,10.4c0.1,1.9-1,4.8,2.9,3.7C38.4,52.7,37.1,48,37.3,43.3z\"/><path d=\"M64.1,32.3c-5.4-1.8-9,2.7-14.9,0.5c2.7-2.6,9.8-1,10.4-5.3c-4.4-2.7-11.2,2.9-16,4.1c-0.3,1.3,0.3,2,1.6,2.2 c-1.6,0.7-1.7,2.3-1.7,3.8c0.8,0.2,1.6,0.4,2.3,0.6c-1.2,0.2-2.3,0.9-3.5,1.2c1.2,3,6.8,3.4,8.6,6.5c-2.6-0.4-5.2-1.2-7.5-2.5 c-2,1.7-0.8,3.8-0.9,5.9c0,4.7,4.3,6.1,6.7,9c5.9,2.8,4.7-5.1,1.3-7.2c5.9,4.9,13.5,0.3,3.6-3.9c6.9,1.2,8.3-7.1,1.1-7.9 c1.6-0.1,3.2-0.3,4.8-0.7c1.8-1.4,6.3,2.2,6-3.2C66.3,33.8,65.9,33.2,64.1,32.3z\"/></g>");
        result.append(@"<g id=\"p9\"><path d=\"M58,44.9c-3.6-4-8-7-13.3-4.7c-3.7,0.5-3.1,5.7-3.7,8.6c-0.4,4.6,13.7,16.2,12.6,7c-0.3-1.3,0-2.2,1-3 c1.1-0.4-0.1-3.3,2.4-2.2C62,52.6,60.9,46.7,58,44.9z\"/><path d=\"M32.3,43.9c-0.8,0.4-1.4,0.9-1.9,1.5c2.6-4.9-7.1-2.6-4.6-7.8c-0.5-9-29.5,6.6-10.9,4.7 c-5.4,2.7-1.3,9,2.5,4.8C12,53,14.8,58,22.7,51.8c-3.5,4.1-0.4,12.4,4.2,5.7C27.5,70.6,40.1,43.7,32.3,43.9z\"/><path d=\"M39.4,43.4c-4.3-1.9-4.4,3.7-3.5,6.1c0.5,3.2-1.2,8,0.6,10.4C41.1,58.2,39.7,47.6,39.4,43.4z\"/><path d=\"M20.5,31.6c3.1,1.3,5.3-0.7,3.6-3.7c-3.6-2.4-14-6.8-17.9-5.4C6.4,28.5,15.7,29.8,20.5,31.6z\"/><path d=\"M61.1,27.3c-1.7-3.4-7.5-0.2-10.6-0.7c0.6-1.9,3.9-2.4,3.1-4.6c-2.7-3-6.8,1.7-9.6,2.6 c1.1-3.5,6.6-7.7,3.4-11.3c-2.2-1.4-2,1.8-3.9,1.8c0.2-1.4,0.2-2.7-1.5-3c-3.1,0.3-3,4.9-4.3,7.1c-0.1-1.7-2-2.7-2.1-4.5 c-1.2-2.1-1.5-5.6-5.5-3.9c-9-7.9-3,8-1.2,11.8C26,20.2,23,17.8,20.3,15c-0.6-0.6-1.2-1.9-2.2-1.2c-3.2,1.8,9.8,16.2,11.2,12.7 c1.2,1,1.7-1,2.6-0.9c2.2-5,6.3,0.2,10.4-0.1c0.4,1.8,1.1,4.3,2.5,5.4c0.1,0.5,2.1-0.8,0.8,1c-1.9,6,5,0.8,7.2-0.3 c1.9-0.2,3.4-0.9,4.9-2.2C59,26.8,61.2,30,61.1,27.3z\"/></g>");
        result.append(@"<g id=\"pa\"><path d=\"M26.9,43.4L26.9,43.4c4-1.7,0.9-11.3-2.7-11.4c-1,5.3-8.5,2.7-12.4,3c-5.4,2.2-0.6,3.3,2.9,3.5 c-8.3,3.2-3.1,1.9-3.7,4.5c-1.7,5.7,10.1-1.9,12.9-2.2c-5.7,4-14.7,17.1-1.3,6.8c-6.9,8.6-4.8,9.9,2.9,2.1 C16.5,70.6,41.2,41.4,26.9,43.4z\"/><path d=\"M46.1,43.2c-0.5-1.7-7.8-3-5.1,0.6c-3.5-2.6-3.4,3.8-3.2,5.3c-0.6,2.9,3,4.8,3.4,7.7 c4.7,2.3,1.9-8.2,1.3-10.4C49.4,54.5,53.4,52.6,46.1,43.2z\"/><path d=\"M37.5,45.8c-6.2-6.1-5.3,11.2-2.6,13.8C38.6,56.7,35.5,49.9,37.5,45.8z\"/><path d=\"M10.6,21.6c4.9,1.7,15.1,14.1,18.7,7.1C23.6,12.6-2.9,13.5,11,18C7.6,19.6,9.7,20.5,10.6,21.6z\"/><path d=\"M57.5,31.8c9.8-6-7.7-7-11.2-4.2c8.6-4.2,15.9-22.8,0.3-10.2c7.1-12.9-6.8-6.9-9.1,0.7 c5.2-32.2-15,5.4-3.9,7.5c0.1,3.4,7.3,4.5,8.1,8.3C39.9,44.4,72.6,37.8,57.5,31.8z\"/></g>");
        result.append(@"<g id=\"pb\"><path d=\"M39.7,42.3c-2.7,0.6-2.4,2.6-4.3,4.1c-1.7-0.4-5.2-5.6-5.8-3c-5.2,5.6-5.6,25.1,1,8.8 c0.9,13.9,5.5,1.8,4.8-4.7c0.9,4.1,5.4,15.6,5.6,5c5.8,8.2,3.5,1.9,5.3-3C48.2,45.9,43.1,42.5,39.7,42.3z\"/><path d=\"M53.3,44.5c-1.7-2-4-3.6-6.4-5C30.8,33.4,59.9,54.1,53.3,44.5z\"/><path d=\"M28.9,42.9c1.9-1.9-2.4-2-2.2-3.5c-4.5-1.9-22.2,15.6-6,8.8c-1.1,1.2-2.1,2.4-3.2,3.7 C22.4,52.5,25.9,46.1,28.9,42.9z\"/><path d=\"M55.8,34.2c9.4-3.8-16.3-3.4-11.2,1.2C45.9,40.4,65.6,39.1,55.8,34.2z\"/><path d=\"M14.3,32.5c2.2,2.1,18.8,3.6,11.4-2c7.4,2.3,2.6-4.7,0.1-7.4c-2.4,4.6-6.3-3.2-10.2-2.1 c-0.8,2.4,2.8,4.1,3,6.4C12.3,26.3,6.8,26.6,14.3,32.5z\"/><path d=\"M24.4,38.9c2.3-1.3,1.9-0.8-0.1-1.8c0.3-0.8,1.7-0.5,1.6-1.6C10.2,35.7,4.9,43.8,24.4,38.9z\"/><path d=\"M28.1,17.5c0.6,2.3,1.5,10.4,4.9,6c0.6-1,1.1-0.3,1.7,0.1c9.9,5.6,13.2-0.4,22.9-2.4c1-5.3-3.4-5-7.6-3.4 c6.6-12.6-7.5-0.4-10.6,3.2c6.4-9.9,3.9-26.6-2.9-6.6c-0.3-4.8,0.3-13.6-6.4-8.7C23.4,5.4,27.8,13.8,28.1,17.5z\"/></g>");
        result.append(@"<g id=\"pc\"><path d=\"M28.8,40.4c-3-1.1-1.2-6.1-4.8-6.1c-3.6-1.8-9.6,0.8-9.9,5.1c0.3,0.3,1.4-0.1,0.9,0.7 c-2.7,4.4,3.3,2.4,5.2,2.2c-5.2,3.6-6.4,11,1.6,5.4c-6.2,12.8,11.9-1.7,7.8-5.8\"/><path d=\"M23.5,33.5c1,0.2,0.7-1.4,1.7-1.2c-4.2-4-10.1-5.7-15.1-2.4C13.8,33.3,18.4,33.9,23.5,33.5z\"/><path d=\"M55.9,47.6c-2.2-3.7-6.9-5.3-8.1-9.7c-4.2-0.1-6,2-5.9,6c-1-0.7-1.2-2.3-2.6-2.6l-1,3.7 c-4.5-6.8-6.2,7.7-5.4,10.8c1.2,9.3,6.7-3.6,5.7-7.3c3.5,17.3,6,4.9,3.9-4.2c2.2,2.5,6.6,10.1,10.1,7 C55.8,52.5,58.9,52.4,55.9,47.6z\"/><path d=\"M35.6,25.9c3.5-11-11-26.5-4.7-4.2c-2.1-1.7-9.5-11.8-8.9-4c-7.9-5.2-5.9,0.9-1.3,4.7c2,3.6,7.7,9,9.5,3.2 C30,28.8,34.5,28.3,35.6,25.9z\"/><path d=\"M38.5,28c1.8,1.1,2.3,1.7,5.5,2.4c4.5,2.5,20.8-17.8,5.9-8.6c6.6-10.7-1.3-6.9-5.8-1.2 c1.1-2.7,2.7-8.1,0.1-10.2C41.4,10.2,36.1,24.9,38.5,28z\"/></g>");
        result.append(@"<g id=\"pd\"><path d=\"M32.5,41.3c-8.8-14.2,9.7-8.6,4.7-23.1c-0.1-1.4-1.1-2.7-3-3.1c-2.2-0.4-6.6,5.7-4.1,8.1 c-1.7-3.3-7.6-5.7-8.9-0.6c-4.6-3.2-6.6-4.5-5.6,2.8c-16.5-0.4,5.4,6,9.4,7.7c-4.2-2-19.5,8.6-7.9,7.9c-2.4,1.3-7,3.3-2.8,6.4 c5.2,2.4,6.2-4.9,12.3-6c-14.9,9.2-3.4,18.7,4.4,6.1C37,72.4,51.7,40.9,32.5,41.3z\"/><path d=\"M53.5,35.2c3.7-1,6.9-0.4,9-4.5c-0.1-1.6-8.8,0-12.1-0.8c-5.5-1.4-4.5-3.6,0.3-8.6c4-4.2-3-4.8-6-3.7 c-4.1,1.5-3.8,5-5.7,7.5c-5.5,4.5,5.6,8.2,2,14.2c-0.9,11.9,26.3,24.5,6.9,3.8C61.9,48.7,71.7,43.2,53.5,35.2z\"/></g>");
        result.append(@"<g id=\"pe\"><path class=\"st6\" d=\"M18.6,23.4c3,1.9,4.7,6.3,8.6,5.6C34.9,27.6,12.7,12.7,18.6,23.4z\"/><path class=\"st6\" d=\"M24.7,20.4c2,2,2.2,6,5.7,6c6.9,0.4,2.7-8.5,1.3-12.1c-0.6-1.7-3-3.8-4.7-2c-1.2,1.6,2,5.2-0.6,5 C23.5,13.4,23.5,18,24.7,20.4z\"/><path class=\"st6\" d=\"M42.8,19c-0.6-10.3-4.1-1.4-4.7-6.1c-0.3-2.4-1.3-1.6-1.8,0c-2.7,2.2-1.8,6.9-1.8,10 C35.3,28.6,44.6,24.8,42.8,19z\"/><path class=\"st6\" d=\"M20.5,32.7c12.5,1.2,0.5-6-5.7-5C8.6,29.2,18.4,32.5,20.5,32.7z\"/><path class=\"st6\" d=\"M20.4,39.7c2.2-0.4,9.5-2.9,4-4.2c-3.1,1.1-6.9,0.4-9.5,3C12.9,41.8,18.9,40.3,20.4,39.7z\"/><path class=\"st6\" d=\"M57.5,26.8c-2,0-0.9-2.6-2.6-2.8c-3.3-0.9-10.1-0.3-11,3c4.3,1-2.9,4.8,1.8,5.3c1.4-0.4,2.6,0.2,4,0.8 c-1.5,1.4-5.9,1.3-3,4.2c2,1.9,5.1,5.5,8.5,4c-0.7-2.2-3.4-2.4-5.3-3.9c3.3-0.5,3.5-1.8,1.3-3.7C52.2,30.2,58.8,30.8,57.5,26.8z\" /><path class=\"st6\" d=\"M27.7,43.1c-2.4-5.3-9.8,2.9-9.7,6.4C21.3,53.5,24.7,44.7,27.7,43.1z\"/><path class=\"st6\" d=\"M34.4,43.4c-1,1.7-2.6,2.3-4.5,2.4c-2.1,2-6.3,13-0.1,9.5c3.8,1.2,2.8-2.5,6-2.3c4.6-1.9,1.7-6.3-0.1-9.2 C35.7,43.6,34.5,43.3,34.4,43.4z\"/><path class=\"st6\" d=\"M41.9,40.3c2.8,4,5.2,8.4,10.2,7.8C51.1,44.3,46,42.5,41.9,40.3z\"/><path class=\"st6\" d=\"M40.2,43.6c0,4.9-0.7,9.9,3.7,12.3C45.3,52.2,42.2,47.8,40.2,43.6z\"/><path class=\"st6\" d=\"M29,44.9c-1-1-9,7-6.9,8.2C24.2,55.8,29.6,47.1,29,44.9z\"/></g>");
        result.append(@"<path id=\"m10\" d=\"M44.2,33.3c-0.7-2.7-2-5.1-3.9-7.2c-0.5-0.5-1.1-0.8-1.7-1.1c-1.1-0.2-2.2-0.3-3.2,0.3 c-2.7,1.1-2.6,1.5-5.1,1.7c-1,0.4-3.2,3.5-3.3,4.4c0.1,1.6-1.9,2.6-1.2,4.3c1.7,2.4,1.6,6.4,5.8,6.6c0,0.7,0.3,1.2,0.9,1.6 c0.4,0.2,0.8,0.3,1.2,0.3c1.3,0.1,2.6,0.3,3.8-0.2c0.9-0.6,1.6-1.4,2.4-2.1c1.2-1,2.4-1.9,3.1-3.4c0.2-0.4,0.5-0.8,0.7-1.2 c0.3-0.6,0.6-1.2,0.7-1.9C44.4,34.7,44.4,34,44.2,33.3z\"/>");
        result.append(@"<path id=\"m11\" d=\"M37.4,44.6c-5,0.8-6.3-4.5-9.9-6c-1.7-2.3-0.9-4.6-0.1-6.9c-0.6-1-1.2-1.9-1.9-2.9 c3.9-5.1,8.3-5.2,13-0.1c0.2,0.3,0.4,0.3,0.7,0.3c2.6,0.2,3.3,2.3,4.2,4.3C44.1,40.5,42.7,43,37.4,44.6z\"/>");
        result.append(@"<path id=\"m12\" d=\"M35.7,44c-0.3,0-0.6,0-0.9,0.1c-0.2-0.4-0.5-1.2-0.7-1.2c-6.9,1.1-5.9-4.8-7.5-8.4 c-0.1-0.3-0.4-0.5-0.6-0.8c0-1.5,0.9-2.3,2.2-2.9c1.8,0,0.9-1,0.6-1.7c0.8-1.3,1.5-2.7,3.2-3.1c1.3-0.3,2.5-0.2,3.8,0.2 c2.7,1.8,7,1.2,7.8,5.5c0.3,0.6,0.6,1.3,0.8,1.9c0.2,0.7,0.2,1.4,0,2c-0.3,0.7-1,0.9-1.5,1.4c-0.9,2.6-2.7,4.4-5,5.8 C37.1,43,36.2,43.1,35.7,44z\"/>");
        result.append(@"<path id=\"m13\" d=\"M44.8,33.8c-0.3-1.3-0.5-2.6-1.2-3.7l-1.7-1.2c-4.2-3.5-8.5-3.3-12.8-0.3c-1.2,0.6-3.1,0.5-2,2.9 c0.5,1,0.5,2.6-0.8,3.6c-1,0.6-1.2,1.5-1.2,2.6c0.1,0.5,0.2,0.9,0.5,1.4c1.3,1.3,2.2,2.9,3.3,4.3c1.2,0.9,2.6,1.3,4.1,1 c1.4-0.7,2.5-1.5,2.1-3.3c0-0.1-0.1-0.1-0.1-0.2c0.8,1.2,1.7,2.3,3.1,2.8C39,44,40,44,40.9,43.6c1-0.5,1.8-1.3,2.5-2.2 c0.4-0.8,0.4-2.2,1.9-1.3c0.2-0.4,0.4-0.7,0.4-1.2C45.4,37.1,44.9,35.5,44.8,33.8z M36.4,37.1c-1,1-2.4,1.9-1.5,3.6 c-0.7-1.3-0.2-3.1-1.5-4.2c-1-0.9-1.4-2.3-0.1-3.4c1-0.9,2.1-0.9,3.1,0.1C37.6,34.5,37.8,35.8,36.4,37.1z\"/>");
        result.append(@"<path id=\"m14\" d=\"M42.6,30.9c0.1-0.3,0.1-0.7,0.2-1c-0.7-0.7-1.4-1.4-2.1-2c-2.1-2.3-5.1-2.2-7.9-2.8 c-0.2,0-1,0.3-1.1,0.5l-3.3,5.2c-0.6,0.8-0.8,3.4,0,5.2c-1.1,1.1-1.5,2.4-0.5,3.8c1.2,1.6,2.9,2.4,4.5,3.4c3.4,1,6.3-0.1,8.9-2.3 c0.8-0.9,1.6-1.9,2-3.1C43.2,35.4,44,33,42.6,30.9z\"/>");
        result.append(@"<path id=\"m15\" d=\"M43,37.8c-0.8,0.2-1.2,0.9-1.2,1.7c-1.2,2.1-2.9,3.5-5.4,3.6c-8.1,0.3-11-4.6-7.3-12.3 c2.2-4.2,5.7-5.9,9.3-4.5C43.1,28,44.4,31.4,43,37.8z\"/>");
        result.append(@"<path id=\"m16\" d=\"M36.3,43.5c-6.3-0.5-8.9-3-9-8.6c-0.1-3.1,4.5-6.8,8.9-7.2c6.5,3.1,7.9,7.7,4.5,15.2 C39.4,44.3,38,44.7,36.3,43.5z\"/>");
        result.append(@"<path id=\"m17\" d=\"M28.3,30.2c1.6-0.7,3.5-0.9,4.1-3c0.6-0.1,1.2-0.1,1.7-0.2c2.4-0.4,4,1.2,6,2 c2.5,4.2,1.5,10.4-2,13.1c-3.8-0.3-8.4,0.8-9-5.1C28.2,34.8,27.9,32.6,28.3,30.2z\"/>");
        result.append(@"<path id=\"m20\" d=\"M35.7,41.3c-3.1-0.4-5.3-1.9-6.2-5c-1.4-2.2-1.4-4.3,0.3-6.4c0.8-0.6,1.9-0.5,2.8-0.8 c3.3-1.1,5.9-0.2,7.5,2.8s0.7,5.7-1.9,7.9C37.5,40.6,36.7,41.1,35.7,41.3z\"/>");
        result.append(@"<path id=\"m21\" d=\"M35.1,40.1c-2.2,1.1-4.1,0.3-5.8-1.2c1.2-2.5-1.7-3.8-1.8-5.9c0.5-0.3,1.1-0.6,1.6-0.8 c2.8-4.8,4.4-5.2,9.1-2.4c0.6,1.3,0.8,2.9,1.8,4.1c0.5,1,0.8,2.1,0.8,3.2C40.3,40.6,38.5,41.8,35.1,40.1z\"/>");
        result.append(@"<path id=\"m22\" d=\"M38.9,27.9c0.3-0.1,0.5,0,0.8,0.2c1.5,1.4,1.9,3.2,1.6,5.2c-0.1,0.5-0.3,0.9-0.6,1.3 C39.5,37,38.4,39.5,35,39c-2.9-0.4-4.3-2.2-4.4-5c0.1-0.8,0.5-1.5,1-2.1l0.3-0.1C33.5,29,36.8,29.4,38.9,27.9z\"/>");
        result.append(@"<path id=\"m23\" d=\"M35.9,40.9c-1.4-0.9-1.7-2.6-3-3.7c-2.1-1.7-2.2-3.8,0.4-5.6c2.3-1.5,4.2-1.7,5.5,1.1 c1,2.1,2.8,4.6-1.2,5.7C36.1,38.8,35.9,39.8,35.9,40.9C35.8,41,35.9,40.9,35.9,40.9z\"/>");
        result.append(@"<path id=\"m24\" d=\"M38.5,33.3c-0.4-2.9-4.1-1.3-4.7-2.8c-1.5-0.4-3,0-3.1,1.9l0.2,1.7c0.3,2,2,3.5,3.3,5.1 c0.2,0,0.4,0,0.7-0.1C36.9,37.7,38.9,36.2,38.5,33.3z\"/>");
        result.append(@"<path id=\"m25\" d=\"M41.7,32.3c-0.5,1.6-3.3,0.2-3.4,3c-0.1,2-2.2,3.1-4.6,2.3c-2-0.7-1.8-2.5-1.5-3.6 c0.6-2,1.9-4.4,4.5-3.3c1.9,0.8,3.4,1,5-0.2C42.5,31.1,42.4,31.7,41.7,32.3z\"/>");
        result.append(@"<path id=\"m26\" d=\"M38.4,34.1c-1.6,0.2-2.4,2.2-4,2.4c-0.6,0.1-3.2,0-2.9-2.4c0.3-2,1.5-2.8,3.4-2.7 C36.5,31.5,37.9,31.9,38.4,34.1z\"/>");
        result.append(@"<path id=\"m27\" d=\"M34.5,31.2c1,2.1-0.3,3.1-2,3.6c-0.7,0.2-1-0.7-1-1.4C31.3,31.2,33,31.4,34.5,31.2L34.5,31.2z\"/>");
        result.append(@"</defs>");
        //
        // open main group
        result.append(@format!("<g class=\"g\" style=\"transform:translate(-{}px,-{}px)\">",
            HALF_SIZE,
            HALF_SIZE,
        ));
        result.append(@format!(
            "<rect x=\"{}\" y=\"{}\" width=\"{}\" height=\"{}\" class=\"bg\"/>",
            HALF_SIZE,
            HALF_SIZE,
            VIEWPORT_W,
            VIEWPORT_H,
        ));
        //---------------------------
        // Build flowers
        //
        let PS: u8 = 15;    // petals count
        let M1S: u8 = 8;    // miolos1 count
        let M2S: u8 = 8;    // miolos2 count
        // number of asters
        let mut aster_count: usize = density * density;
        if (distribution == Distribution::Chaos) {
            aster_count = aster_count * 2;
        }
        // build asters
        let mut layer_0: ByteArray = "";
        let mut layer_1: ByteArray = "";
        let mut layer_2: ByteArray = "";
        let mut layer_3: ByteArray = "";
        let mut i: usize = 0;
        while i < aster_count {
            let cx: usize = HALF_SIZE + SIZE * (i % density);
            let cy: usize = HALF_SIZE + SIZE * ((i / density) % density);
            let (x, y): (usize, usize) = match distribution {
                Distribution::Order => (
                    cx,
                    cy,
                ),
                Distribution::Spread => (
                    cx - (HALF_SIZE/2) + props.seeder.get_next_u16_usize(HALF_SIZE),
                    cy - (HALF_SIZE/2) + props.seeder.get_next_u16_usize(HALF_SIZE),
                ),
                Distribution::Chaos => (
                    if (density == 1) {(
                        cx - (HALF_SIZE/2) + props.seeder.get_next_u16_usize(HALF_SIZE),
                        cy - (HALF_SIZE/2) + props.seeder.get_next_u16_usize(HALF_SIZE),
                    )} else {(
                        cx - HALF_SIZE + props.seeder.get_next_u16_usize(SIZE),
                        cy - HALF_SIZE + props.seeder.get_next_u16_usize(SIZE),
                    )}
                ),
            };
            // layers
            let p1: u8 = props.seeder.get_next_u8(PS/2);
            let p2: u8 = p1 + 1 + props.seeder.get_next_u8(PS-p1-1);
            let m1: u8 = props.seeder.get_next_u8(M1S);
            let m2: u8 = props.seeder.get_next_u8(M2S);
            // depth color
            let mut z: usize = props.seeder.get_next_u8_usize(4);
            if (density == 1 && z == 0) { z += 1; }
            let pz1: usize = z;
            let pz2: usize = pz1+1;
            let mz1: usize = if(z==0) {0} else if(z==3) {2} else {z-(i%2)};
            let mz2: usize = mz1+1;
            // render object
            let line: ByteArray = format!(
                "<g style=\"transform:scale(1)translate({}px,{}px)\"><use href=\"#p{:x}\" class=\"p{} r r{} sh\"/><use href=\"#p{:x}\" class=\"p{} r r{} bl\"/><use href=\"#m1{:x}\" class=\"m{} r r{} sh\"/><use href=\"#m2{:x}\" class=\"m{} r r{}\"/></g>",
                x, y,
                p1, pz1, ((i+0)%5),
                p2, pz2, ((i+1)%5),
                m1, mz1, ((i+2)%5),
                m2, mz2, ((i+3)%5),
            );
            // add to layer
            if (z == 0) {
                layer_0.append(@line);
            } else if (z == 1) {
                layer_1.append(@line);
            } else if (z == 2) {
                layer_2.append(@line);
            } else {
                layer_3.append(@line);
            }
            // result.append(@format!("<g style=\"transform:scale(1)translate({}px,{}px)\">", x, y));
            // result.append(@format!("<use href=\"#p{:x}\" class=\"p{} r r{}sh \"/>", (p1+1), pz1, ((i+0)%5)));
            // result.append(@format!("<use href=\"#p{:x}\" class=\"p{} r r{} bl\"/>", (p2+1), pz2, ((i+1)%5)));
            // result.append(@format!("<use href=\"#m1{:x}\" class=\"m{} r r{} sh\"/>", (m1+1), mz1, ((i+2)%5)));
            // result.append(@format!("<use href=\"#m2{:x}\" class=\"m{} r r{}\"/>", (m2+1), mz2, ((i+3)%5)));
            // result.append(@"</g>");
            i += 1;
        };
        result.append(@layer_0);
        result.append(@layer_1);
        result.append(@layer_2);
        result.append(@layer_3);
        //----------------
        // close it!
        //
        result.append(@"</g></svg>");
        (result)
    }

}
